<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>BlinkyTune: BlinkyTune</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="blinkytune_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BlinkyTune
   &#160;<span id="projectnumber">v1.0</span>
   </div>
   <div id="projectbrief">Sound reactive RGB LED strip control software.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">BlinkyTune </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="../blinkytune_big.png" />
</div>
 <h2>Autorzy</h2>
<p>Łukasz Kilaszewski (259822)<br />
 Marcin Baran (Z59804)</p>
<h2>Opis projektu</h2>
<p>BlinkyTune to aplikacja, która na podstawie analizy strumienia audio kontroluje pasek adresowalnych diod LED RGB. Kolory poszczególnych diod dobierane są w taki sposób, aby generować ciekawe efekty świetlne, zsynchronizowane np. z odtwarzaną aktualnie muzyką. Użytkownik ma możliwość wyboru źródła analizowanego dźwięku, jednego z dostępnych efektów, a także wartości jego ustawień. Każdy efekt posiada indywidualny zbiór parametrów, które wpływają na jego zachowanie. Urządzenie, odpowiadające za wyświetlanie efektów świetlnych, złożone jest z paska 60 diod LED WS2812B, podłączonych do modułu opartego o układ Espressif ESP8266. Układ ten umożliwia podłączenie urządzenia do domowej sieci WiFi, a następnie komunikację z komputerem za pomocą protokołu UDP. Wykorzystanie łączności bezprzewodowej pozwala na wyświetlanie efektów z dala od komputera. Program dla modułu ESP8266, odpowiadający za odbieranie danych od aplikacji i sterowanie paskiem LED, nie wchodzi w skład projektu.</p>
<h2>Interfejs użytkownika</h2>
<p>Na potrzeby projektu został stworzony interfejs użytkownika, który umożliwia utworzenie połączenia z urządzeniem (po wpisaniu adresu IP), Wybranie urządzenia audio obsługującego przychodzące próbki audio oraz wybór i dostosowanie parametrów generowanego efektu świetlnego.sss</p>
<div class="image">
<img src="../GUI.png" />
</div>
 <p>Na interfejs składają się następujące panele:</p><ol type="1">
<li>Pole wpisywania adresu IP, w którym użytkownik definiuje adres urządzenia, z którym chce się połączyć.</li>
<li>Przycisk połączenia z urządzeniem. Jeżeli połączenie będzie udane, indykator 3 zaświeci się na zielono. Jeżeli użytkownik wpisze zły adres wyświetli się monit informujący o źle wpisanym adresie IP.</li>
<li>Indykator pokazujący stan połączenia. Gdy jest zielony- udało się połączyć z urządzeniem, gdy czerwony- brak połączenia.</li>
<li>Panel wyboru urządzenia audio pozwala za pomocą kliknięcia myszy zdefiniować systemowe urządzenie audio używane do uzyskania próbek audio.</li>
<li>Panel wyboru efektu pozwala wybrać zdefiniowany efekt świetlny wyświetlany przez połączone urządzenie. Dopóki nie istnieje połączenie, panel jest nieaktywny.</li>
<li>Panel wyboru ilości danych na sekundę, pozwala ustalić jak szybko przebiegała będzie animacja (możliwe wartości od 10 do 60 fps).</li>
<li>Panel ustawień efektu pozwala na zdefiniowanie parametrów charakterystycznych dla danego efektu. W zależności od wybranego w panelu 6 efektu, możliwe parametry będą się zmieniać. Nowe parametry dla efektu ustawiane są za pomocą przycisku 'Send parameters'.</li>
</ol>
<h2>Zasada działania</h2>
<h3>Protokół komunikacji z paskiem LED</h3>
<p>Do przesyłania danych o składowych kolorów poszczególnych diod LED wykorzystywany jest protokół UDP. Pojedyncza ramka, stanowiąca podstawę działania systemu komunikacji, ma następującą strukturę: </p><table class="doxtable">
<tr>
<th align="center">Dioda LED 1 </th><th align="center">Dioda LED 2 </th><th align="center">... </th><th align="center">Dioda LED N  </th></tr>
<tr>
<td align="center"><span style="color:red">Red</span> <span style="color:green">Green</span> <span style="color:blue">Blue</span> (3 bajty)</td><td align="center"><span style="color:red">Red</span> <span style="color:green">Green</span> <span style="color:blue">Blue</span> (3 bajty)</td><td align="center">... </td><td align="center"><span style="color:red">Red</span> <span style="color:green">Green</span> <span style="color:blue">Blue</span> (3 bajty) </td></tr>
</table>
<p>Łącznie pojedyncza ramka ma <code>3*N</code> bajtów, gdzie <code>N</code> to liczba diod LED w pasku. Ramka ta reprezentuje pojedynczą klatkę animacji.</p>
<h3>Przetwarzanie dźwięku</h3>
<p>W celu wyznaczenia interesujących cech dźwięku, na podstawie których można generować efekty, program wykonuje szereg czynności:</p><ul>
<li>pobieranie próbek audio z wybranego urządzenia audio</li>
<li>wyznaczanie widma przechwyconego sygnału audio</li>
<li>filtracja i analiza widma</li>
</ul>
<p>Za czynności te odpowiadają osobne wątki, które wymieniają ze sobą dane za pomocą kolejek FIFO. Próbki audio przetwarzane są przez wątki potokowo. Osobno przekazywane są dane dla lewego i prawego kanału audio. Ich ewentualne połączenie następuje dopiero podczas generowania konkrentego efektu świetlnego.</p>
<h4>Akwizycja próbek audio</h4>
<p>Pobieranie próbek odbywa się w wątku obsługiwanym przez klasę <a class="el" href="class_samples_collector.html">SamplesCollector</a>. Interfejs biblioteki PortAudio umożliwia synchroniczne pobieranie buforów zawierających najnowsze próbki. Wątek przekazuje pobrane próbki do kolejnego, wyznaczającego widmo, za pomocą kolejki FIFO łączącej oba wątki.</p>
<h4>Wyznaczanie widma</h4>
<p>Po odebraniu próbek audio z kolejki FIFO, wątek <a class="el" href="class_spectrum_generator.html">SpectrumGenerator</a> wywołuje funkcje biblioteki kfr umożliwiające wyznaczenie widma sygnału za pomocą szybkiej transofrmaty Fouriera (FFT - ang. Fast Fourier Transform). Po wyznaczeniu pierwotnego widma następuje jego przetworzenie na skalę <a href="https://pl.wikipedia.org/wiki/Mel_(skala)">mel</a>. Dzięki temu zabiegowi, kolejne częstotliowści rozmieszczone w widmie są odbierane przez człowieka jako liniowo narastające, co poprawia wizalną jakość generowanych efektów. Tak przetworzone widmo sygnału trafia poprzez kolejkę FIFO do kolejnego wątku, dokonującego analizy.</p>
<h3>Analiza widma</h3>
<p>Wątek <a class="el" href="class_spectrum_analyzer.html">SpectrumAnalyzer</a> wyznacza na podstawie widma i próbek takie parametry, jak:</p><ul>
<li>głośność sygnału (jako chwilowa energia)</li>
<li>średnia głośność sygnału (jako średnia energia), na podstawie przechowywanej historii danych</li>
<li>dominujące częstotliwości w widmie</li>
<li>zgrupowane amplitudy dla tonów niskich, średnich i wysokich</li>
</ul>
<p>W celu poprawienia płynności efektów, wątek ten filtruje też widmo, aplikując wygładzanie wykładnicze do każdej z wartości amplitud widma lewego i prawego kanału. W celu wyznaczenia amplitud tonów niskich, średnich i wysokich widmo dzielone jest na 3 części, a następnie dla każdej części obliczana jest średnia amplituda.</p>
<p>Wyznaczone wartości wysyłane są poprzez kolejkę FIFO do wątku generującego efekty.</p>
<h3>Generowanie efektów</h3>
<p>Generowanie efektów odbywa się w wątku obsługiwanym przez klasę <a class="el" href="class_effects_renderer.html">EffectsRenderer</a>. Odbiera ona z kolejki FIFO dane dotyczące analizy sygnału audio, a następnie wykonuje operacje na pasku LED zależne od wybranego efektu. W przypadku efektów niezależnych od dźwięku, dane analizy audio nie są wykorzystywane.</p>
<h3>Zarządzanie potokiem generowania efektów</h3>
<p>Za zarządzanie aktywnym efektem odpowiada klasa <a class="el" href="class_effects_controller.html">EffectsController</a>, stanowiaca fasadę całego systemu generowania efektów. Każdy z efektów przypisany jest do jednej z grup efektów, reprezentowanych przez odpowiednie klasy abstrakcyjne:</p><ul>
<li>efekty zależne od dźwięku (klasa <a class="el" href="class_sound_effect.html">SoundEffect</a>)</li>
<li>efekty niezależne od dźwięku (klasa <a class="el" href="class_no_sound_effect.html">NoSoundEffect</a>)</li>
</ul>
<p>W zależności od typu wybranego efektu, klasa startuje jedną z grup wątków stanowiących kompletny potok generowania efektów:</p><ul>
<li><a class="el" href="class_samples_collector.html">SamplesCollector</a>, <a class="el" href="class_spectrum_generator.html">SpectrumGenerator</a>, <a class="el" href="class_spectrum_analyzer.html">SpectrumAnalyzer</a>, <a class="el" href="class_effects_renderer.html">EffectsRenderer</a> (dla efektów o klasie bazowej <a class="el" href="class_sound_effect.html">SoundEffect</a>)</li>
<li><a class="el" href="class_tick_generator.html">TickGenerator</a>, <a class="el" href="class_effects_renderer.html">EffectsRenderer</a> (dla efektów o klasie bazowej <a class="el" href="class_no_sound_effect.html">NoSoundEffect</a>)</li>
</ul>
<p>Klasa <a class="el" href="class_tick_generator.html">TickGenerator</a>, wraz ze swoim wątkiem, odpowiada za cykliczne wstawianie do wejściowej kolejki FIFO wątku <a class="el" href="class_effects_renderer.html">EffectsRenderer</a> pustych buforów, reprezentujących "fałszywą" (pustą) analizę audio. Dzięki temu, w przypadku, gdy wybrany jest efekt z rodziny <a class="el" href="class_no_sound_effect.html">NoSoundEffect</a>, nie są pobierane, ani przetwarzane próbki audio, aby nie marnować zasobów. Puste bufory odebrane z kolejki są przez klasę <a class="el" href="class_effects_renderer.html">EffectsRenderer</a> ignorowane - napływające bufory stanowią tylko podstawę czasu dla generowania efektów niezależnych od dźwięku.</p>
<h2>Wykorzytane techniki i wzorce projektowe</h2>
<p>Program korzysta między innymi z następujących wzorców projektowych:</p><ul>
<li>singleton (klasy <a class="el" href="class_audio_interface.html">AudioInterface</a>, <a class="el" href="class_effects_controller.html">EffectsController</a>, <a class="el" href="class_effects_factory.html">EffectsFactory</a>)</li>
<li>fabryka obiektów (klasa <a class="el" href="class_effects_factory.html">EffectsFactory</a>)</li>
<li>fasada (klasa <a class="el" href="class_effects_controller.html">EffectsController</a>)</li>
<li>monitor (klasa <a class="el" href="class_f_i_f_o_queue.html">FIFOQueue</a>)</li>
<li>adapter (<a class="el" href="class_u_d_p_sender.html">UDPSender</a>)</li>
</ul>
<p>Oprócz tego wykorzystywane są zaawansowane elementy języka C++, takie jak:</p><ul>
<li>klasy szablonowe (klasa <a class="el" href="class_f_i_f_o_queue.html">FIFOQueue</a>)</li>
<li>wielowątkowość (np. klasy <a class="el" href="class_samples_collector.html">SamplesCollector</a>, <a class="el" href="class_spectrum_generator.html">SpectrumGenerator</a>)</li>
<li>hierarchiczne dziedziczenie (rodzina klas <a class="el" href="class_effect.html">Effect</a>)</li>
</ul>
<h2>Statystyki</h2>
<ul>
<li>liczba linii kodu (obliczona za pomocą narzędzia <a href="https://www.dwheeler.com/sloccount/">SLOCCount</a>): 1990</li>
<li>liczba testów jednostkowych: 5</li>
<li>liczba godzin pracy nad projektem: ~150</li>
</ul>
<h2>Napotkane problemy i dalszy rozwoju projektu</h2>
<p>Podczas implementacji programu napotykaliśmy głównie problemy związane z szeroko pojętą tematyką cyfrowego przetwarzania sygnałów. Projekt pozwolił na dogłebne zapoznanie się z transformatą Fouriera oraz filtracją sygnałów.</p>
<p>Planowany jest dalszy rozwój programu, w tym między innymi:</p><ul>
<li>dodanie większej ilości efektów</li>
<li>wykorzystanie bardziej zaawansowanych algorytmów analizy dźwięku (np. wykrywanie uderzeń, tempa)</li>
</ul>
<p>Aktualnie zaimplementowane funkcjonalności nie wykazują żadnych widocznych problemów z wydajnością lub stabilnością. Z tego względu, program zaimplementowany w ramach projektu stanowi dobrą bazę do dalszego rozwoju umiejętności autorów.</p>
<h2>Budowanie projektu</h2>
<p>Projekt korzysta z następujących bibliotek:</p>
<ul>
<li>portaudio: <a href="http://www.portaudio.com/">Portaudio</a></li>
<li>kfr: <a href="https://www.kfrlib.com/">kfr</a></li>
<li>Qt5: <a href="https://www.qt.io/">Qt5</a></li>
<li>Boost (version &gt;= 1.34.0) <a href="http://www.boost.org/">Boost</a></li>
</ul>
<p>Źródła bibliotek Portaudio i kfr są dołączone do repozytorium. Pozostałe biblioteki muszą zostać manualnie zainstalowane w systemie.</p>
<h3>Zależności projektu:</h3>
<h4>Linux:</h4>
<ul>
<li>GCC (wersja obsługująca standard C++14)</li>
<li>CMake (wersja &gt;= 3.5)</li>
<li>Git</li>
</ul>
<h4>Windows:</h4>
<ul>
<li>Microsoft Visual C++ (wersja &gt;= Visual Studio 2015 Update 2)</li>
<li>CMake (wersja &gt;= 3.5)</li>
<li>Git</li>
</ul>
<h3>Kompilacja</h3>
<h4>Linux:</h4>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;git clone --recursive https://github.com/luktor99/blinkytune.git</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;mkdir cmake-build</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;cd cmake-build</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;cmake -DQt5_DIR=/path/to/Qt5 ..</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;make -j 4</div></div><!-- fragment --><h4>Windows:</h4>
<p>Należy wykonać następujące polecenia w Visual Studio Command Prompt:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;git clone --recursive https://github.com/luktor99/blinkytune.git</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;mkdir cmake-build</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;cd cmake-build</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;cmake -G &quot;Visual Studio 14 2015&quot; -DQt5_DIR=C:\path\to\Qt5 ..</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;msbuild blinkytune.sln</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
